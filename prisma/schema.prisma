// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  BRANCH_ADMIN
  TEACHER
  STUDENT
  PARENT
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String?
  role          UserRole  @default(STUDENT)
  phoneNumber   String?
  address       String?
  profileImage  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  superAdmin    SuperAdmin?
  branchAdmin   BranchAdmin?
  teacher       Teacher?
  student       Student?
  parent        Parent?
  
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  auditLogs        AuditLog[]
}

model Branch {
  id          String   @id @default(uuid())
  name        String
  address     String?
  phoneNumber String?
  email       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  admins      BranchAdmin[]
  students    Student[]
  teachers    Teacher[]
  classes     Class[]
  announcements Announcement[]
}

model SuperAdmin {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model BranchAdmin {
  id       String @id @default(uuid())
  userId   String @unique
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])
}

model Teacher {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  branchId        String
  branch          Branch   @relation(fields: [branchId], references: [id])
  specialization  String?
  
  classes         Class[]
  subjects        Subject[]
  lessons         LessonPlan[]
  assignments     Assignment[]
}

model Student {
  id           String   @id @default(uuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentId     String?
  parent       Parent?  @relation(fields: [parentId], references: [id])
  branchId     String
  branch       Branch   @relation(fields: [branchId], references: [id])
  rollNumber   String
  
  enrollments  Enrollment[]
  attendance   Attendance[]
  submissions  AssignmentSubmission[]
  marks        Mark[]
  feeStatus    FeeStatus[]
}

model Parent {
  id       String    @id @default(uuid())
  userId   String    @unique
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  students Student[]
}

model AcademicYear {
  id        String   @id @default(uuid())
  name      String   // e.g., 2024-2025
  startDate DateTime
  endDate   DateTime
  isCurrent Boolean  @default(false)
  
  enrollments Enrollment[]
}

model Class {
  id       String    @id @default(uuid())
  name     String    // e.g., Grade 10
  branchId String
  branch   Branch    @relation(fields: [branchId], references: [id])
  teacherId String?
  teacher  Teacher?  @relation(fields: [teacherId], references: [id])

  sections    Section[]
  subjects    Subject[]
  feeStructure FeeStructure[]
}

model Section {
  id      String @id @default(uuid())
  name    String // e.g., A, B, C
  classId String
  class   Class  @relation(fields: [classId], references: [id])

  enrollments Enrollment[]
  timetables  Timetable[]
}

model Subject {
  id      String @id @default(uuid())
  name    String
  classId String
  class   Class  @relation(fields: [classId], references: [id])
  teacherId String?
  teacher  Teacher? @relation(fields: [teacherId], references: [id])

  exams       Exam[]
  assignments Assignment[]
}

model Enrollment {
  id             String       @id @default(uuid())
  studentId      String
  student        Student      @relation(fields: [studentId], references: [id])
  classId        String?
  sectionId      String
  section        Section      @relation(fields: [sectionId], references: [id])
  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])
  enrolledAt     DateTime     @default(now())

  @@unique([studentId, academicYearId])
}

model Attendance {
  id        String   @id @default(uuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id])
  date      DateTime
  status    String   // PRESENT, ABSENT, LATE, EXCUSED
  remarks   String?
  createdAt DateTime @default(now())
}

model Exam {
  id        String   @id @default(uuid())
  name      String
  date      DateTime
  subjectId String
  subject   Subject  @relation(fields: [subjectId], references: [id])
  weightage Float    @default(100.0)

  marks Mark[]
}

model Mark {
  id        String @id @default(uuid())
  studentId String
  student   Student @relation(fields: [studentId], references: [id])
  examId    String
  exam      Exam    @relation(fields: [examId], references: [id])
  score     Float
  remarks   String?
}

model Assignment {
  id          String   @id @default(uuid())
  title       String
  description String?
  dueDate     DateTime
  subjectId   String
  subject     Subject  @relation(fields: [subjectId], references: [id])
  teacherId   String
  teacher     Teacher  @relation(fields: [teacherId], references: [id])
  fileUrl     String?

  submissions AssignmentSubmission[]
}

model AssignmentSubmission {
  id           String     @id @default(uuid())
  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id])
  studentId    String
  student      Student    @relation(fields: [studentId], references: [id])
  fileUrl      String?
  submittedAt  DateTime   @default(now())
  grade        String?
  feedback     String?
}

model FeeStructure {
  id      String @id @default(uuid())
  classId String
  class   Class  @relation(fields: [classId], references: [id])
  title   String
  amount  Float
}

model FeeStatus {
  id        String   @id @default(uuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id])
  title     String
  amount    Float
  paid      Float    @default(0)
  status    String   // PAID, UNPAID, PARTIAL
  dueDate   DateTime
  updatedAt DateTime @updatedAt
}

model Announcement {
  id        String   @id @default(uuid())
  title     String
  content   String
  branchId  String?
  branch    Branch?  @relation(fields: [branchId], references: [id])
  target    String   // ALL, TEACHERS, STUDENTS, PARENTS
  createdAt DateTime @default(now())
}

model Message {
  id         String   @id @default(uuid())
  senderId   String
  sender     User     @relation("SentMessages", fields: [senderId], references: [id])
  receiverId String
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  content    String
  createdAt  DateTime @default(now())
  isRead     Boolean  @default(false)
}

model Timetable {
  id        String  @id @default(uuid())
  sectionId String
  section   Section @relation(fields: [sectionId], references: [id])
  day       String  // Monday, Tuesday, etc.
  startTime String
  endTime   String
  subjectId String
}

model LessonPlan {
  id        String   @id @default(uuid())
  teacherId String
  teacher   Teacher  @relation(fields: [teacherId], references: [id])
  title     String
  content   String
  date      DateTime
}

model GradeSystem {
  id      String @id @default(uuid())
  minMark Float
  maxMark Float
  grade   String
  point   Float
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String
  entity    String
  entityId  String
  details   String?
  createdAt DateTime @default(now())
}
